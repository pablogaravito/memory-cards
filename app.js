var ANIMALS_PACK = {
	path: 'res/img/animals/',
	cards: [
		'bee',
		'bird',
		'bird2',
		'bull',
		'butterfly',
		'camel',
		'cat',
		'cat2',
		'cat3',
		'cat4',
		'cobra',
		'cow',
		'crab',
		'deer',
		'deer2',
		'deer3',
		'dog',
		'dolphin',
		'duck',
		'elephant',
		'fish',
		'fish2',
		'fox',
		'frog',
		'giraffe',
		'goat',
		'goose',
		'horse',
		'horse2',
		'kangaroo',
		'koala',
		'ladybug',
		'lion',
		'lion2',
		'monkey',
		'mouse',
		'owl',
		'panda',
		'panda2',
		'panda3',
		'pig',
		'rhino',
		'seal',
		'tiger',
		'turtle',
		'white-tiger',
		'wolf',
		'zebra',
		'zebra2'
	]
}

var ANIMALS4CHILDREN_PACK = {
	path: 'res/img/animals4children/',
	cards: [
		'ant-eater',
		'badger',
		'bat',
		'bear',
		'boar',
		'buffalo',
		'butterfly',
		'camel',
		'cat',
		'chameleon',
		'chameleon-colors',
		'chicken',
		'cow',
		'crab',
		'deer',
		'dog',
		'dolphin',
		'duck',
		'duck-baby',
		'elephant',
		'fish',
		'flower',
		'fox',
		'frog',
		'giraffe',
		'goat',
		'goose',
		'grizzly-bear',
		'hamster',
		'hedgehog',
		'hippo',
		'home',
		'home-garden',
		'horse',
		'kangaroo',
		'koala',
		'ladybug',
		'lion',
		'lizard',
		'meerkat',
		'monkey',
		'moose',
		'mouse',
		'musk-ox',
		'octopus',
		'orca',
		'otter',
		'owl',
		'panda',
		'parrot',
		'pelican',
		'penguin',
		'pig',
		'pinniped',
		'piranha',
		'polar-bear',
		'rabbit',
		'racoon',
		'rhino',
		'seagull',
		'seahorse',
		'sealion',
		'sheep',
		'sloth',
		'snail',
		'snake',
		'squirrel',
		'stork',
		'tiger',
		'toucan',
		'tree',
		'turkey',
		'turtle',
		'whale',
		'wolf',
		'zebra'
	]
}

var CAMPING_PACK = {
	path: 'res/img/camping/',
	cards: [
		'backpack',
		'boat',
		'book',
		'boots',
		'bottle',
		'butterfly',
		'camera',
		'campfire',
		'compass',
		'deer',
		'fish',
		'fishing-rod',
		'flashlight',
		'flower',
		'fox',
		'guitar',
		'hat',
		'kingfisher',
		'knife',
		'lake',
		'landscape',
		'lighter',
		'lighter2',
		'mallard-duck',
		'mountain',
		'mushroom',
		'newspaper',
		'oil-lamp',
		'owl',
		'pot',
		'rabbit',
		'rope',
		'sandwich',
		'shovel',
		'signpost',
		'stone',
		'stone-cairn',
		'stone-cave',
		'stone-ruin',
		'stone-wall',
		'stream',
		'stream-river',
		'swiss-knife',
		'tent',
		'toilet-paper',
		'tree',
		'trees',
		'volleyball',
		'water-lily',
		'waterfall',
		'waterfall2',
		'weather-cloudy',
		'weather-rain',
		'weather-sun',
		'wood',
		'woodpecker',
		'yellow-flower'
	]
}

var CUTEANIMALS_PACK = {
	path: 'res/img/cuteanimals/',
	cards: [
		'bear',
		'buffalo',
		'camel',
		'cat',
		'chicken',
		'cow',
		'crocodile',
		'dog',
		'dolphin',
		'elephant',
		'fish',
		'fox',
		'frog',
		'goat',
		'hamster',
		'horse',
		'koala',
		'ladybug',
		'monkey',
		'mouse',
		'octopus',
		'panda',
		'penguin',
		'pig',
		'rabbit',
		'sheep',
		'snail',
		'tiger',
		'turtle',
		'whale'
	]
}

var DOGS_PACK = {
	path: 'res/img/dogs/',
	cards: [
		'afghan-hound',
		'australian-kelpie',
		'australian-shepherd',
		'basset-hound',
		'beagle',
		'bearded-collie',
		'bernese-mountain-dog',
		'bichon-frise',
		'border-collie',
		'border-terrier',
		'boxer',
		'brittany',
		'bulldog',
		'cane-corso',
		'charles-spaniel',
		'chihuahua',
		'cocker-spaniel',
		'dachshund',
		'dachshund-red',
		'dachshund-wire-haired',
		'dalmatian',
		'doberman',
		'english-foxhound',
		'french-bulldog',
		'german-shepherd',
		'german-shorthaired-pointer',
		'giant-schnauzer',
		'golden-retriever',
		'grand-basset-griffon-vendeen',
		'great-dane',
		'greyhound',
		'irish-red-setter',
		'irish-wolfhound',
		'jack-russel-terrier',
		'japanese-chin',
		'labrador-black',
		'labrador-brown',
		'labrador-yellow',
		'maltese-dog',
		'mastiff',
		'miniature-schnauzer',
		'papillon-dog',
		'pekingese',
		'pharaoh-hound',
		'pomeranian-dog',
		'poodle',
		'poodle-toy',
		'pug',
		'retriever',
		'rhodesian-ridgeback',
		'rottweiler',
		'shar-pei',
		'shetland-sheepdog',
		'shiba-inu',
		'shih-tzu',
		'siberian-husky',
		'st-bernard',
		'vizsla',
		'weimaraner',
		'yorkshire-terrier'
	]
}

var EASTER_PACK = {
	path: 'res/img/easter/',
	cards: [
		'basket1',
		'basket2',
		'bunny',
		'egg1',
		'egg2',
		'egg3',
		'egg4',
		'egg5',
		'egg6',
		'egg7',
		'egg8',
		'egg9',
		'egg10',
		'egg11',
		'egg12',
		'egg13',
		'egg14',
		'egg15',
		'egg16',
		'egg17',
		'egg18',
		'egg19',
		'egg20',
		'egg21',
		'egg22',
		'egg23',
		'egg24',
		'egg25'
	]
}

var FAIRY_PACK = {
	path: 'res/img/fairy/',
	cards: [
		'bat',
		'castle',
		'dark-castle',
		'dragon',
		'hobbit-house',
		'house',
		'magic-book',
		'magic-table',
		'money',
		'moon',
		'potion1',
		'potion2',
		'princess',
		'rose',
		'shield',
		'sword',
		'torch',
		'tree',
		'wizard1',
		'wizard2'
	]
}

var FOOD_PACK = {
	path: 'res/img/food/',
	cards: [
		'apple',
		'baguette',
		'banana',
		'blueberries',
		'bread',
		'cake',
		'cake2',
		'cake3',
		'cake4',
		'cheese',
		'cheesecake',
		'cheesecake2',
		'cherry',
		'chips',
		'cookie',
		'cupcake',
		'dessert',
		'dessert2',
		'donut',
		'egg',
		'fried-chicken',
		'fries',
		'grapes',
		'hamburger',
		'hot-dog',
		'icecream',
		'icecream2',
		'japan-food',
		'ketchup',
		'kiwi',
		'kiwi2',
		'lemon',
		'meat',
		'muffin',
		'muffin2',
		'pear',
		'pie',
		'pizza',
		'popcorn',
		'ramen',
		'raspberry',
		'sandwich',
		'sardines',
		'spaghetti',
		'strawberry',
		'strawberry2',
		'taco',
		'toast',
		'triple',
		'watermelon'
	]
}

var FRUIT_PACK = {
	path: 'res/img/fruit/',
	cards: [
		'apricot',
		'banana',
		'blueberry',
		'cherimoya',
		'cherimoya2',
		'cherries',
		'coconut',
		'cranberry',
		'currant',
		'datepalm',
		'dragonfruit',
		'fig',
		'grape-black',
		'grape-green',
		'green-apple',
		'guave',
		'honeymelon',
		'kiwi',
		'lemon',
		'lime',
		'lychee',
		'mango',
		'mangosteen',
		'melon',
		'mirabelle-plum',
		'orange',
		'papaya',
		'peach',
		'pear',
		'piel-sapo-melon',
		'pineapple',
		'plum',
		'pluot',
		'pomegranate',
		'quince',
		'raspberry',
		'red-apple',
		'red-grapefruit',
		'strawberries',
		'strawberry',
		'watermelon'
	]
}

var GINGERBREAD_PACK = {
	path: 'res/img/gingerbread/',
	cards: [
		'bus',
		'car',
		'car2',
		'car3',
		'cat',
		'dog',
		'gloves',
		'horse',
		'house',
		'house2',
		'houseboat',
		'man1',
		'moon',
		'mouse',
		'plane',
		'reindeer',
		'rocket',
		'santa',
		'snowflake',
		'socks',
		'star',
		'starship',
		'sun',
		'woman1',
		'wreath',
		'xmas-ball',
		'xmas-gift',
		'xmas-tree'
	]
}

var HALLOWEEN_PACK = {
	path: 'res/img/halloween/',
	cards: [
		'axe',
		'bat',
		'bats',
		'broom',
		'candle',
		'candy',
		'candy2',
		'cat',
		'cauldron',
		'cauldron2',
		'coffin',
		'dracula',
		'evil-clown',
		'eye',
		'eyes',
		'face',
		'frankenstein',
		'frankenstein2',
		'ghost',
		'ghost2',
		'haunted-house',
		'kruger',
		'magicball',
		'moon',
		'owl',
		'panic',
		'potion',
		'pumpkin',
		'pumpkin2',
		'reaper',
		'scream',
		'skull',
		'spider',
		'tombstone',
		'tombstone2',
		'voodoo',
		'witch',
		'witch-hat',
		'witch-hat2',
		'witch-hat3',
		'zombie',
		'zombie-hand'
	]
}

var INCOGNITO1_PACK = {
	path: 'res/img/incognito1/',
	cards: [
		'bear',
		'bird',
		'bison',
		'buffalo',
		'cat',
		'cat2',
		'crocodile',
		'dino',
		'dog',
		'elephant',
		'giraffe',
		'gorilla',
		'gorilla2',
		'hedgehog',
		'horse',
		'horse2',
		'kangaroo',
		'koala',
		'lama',
		'leopard',
		'lion',
		'mammoth',
		'meerkat',
		'monkey',
		'mouse',
		'owl',
		'polar-bear',
		'rabbit',
		'raccoon',
		'reindeer',
		'rhinoceros',
		'sloth',
		'sloth2',
		'squirrel',
		'wombat',
		'yak'
	]
}

var INCOGNITO2_PACK = {
	path: 'res/img/incognito2/',
	cards: [
		'baby-monkey',
		'bat',
		'bear',
		'bird',
		'bison',
		'cat',
		'cat2',
		'crocodile',
		'deer',
		'dino',
		'dog',
		'emu',
		'frog',
		'gecko',
		'giraffe',
		'goose',
		'hamster',
		'icebear',
		'kangaroo',
		'koala',
		'lama',
		'lion',
		'lizard',
		'mammoth',
		'meerkat',
		'mole',
		'monkey',
		'mouse',
		'mouse2',
		'octopus',
		'ostrich',
		'owl',
		'panda',
		'pig',
		'rabbit',
		'racoon',
		'rat',
		'rhinoceros',
		'sheep',
		'squirrel',
		'starfish',
		'turtle',
		'whale',
		'wolf',
		'wombat',
		'yak'
	]
}

var PLASTIC_PACK = {
	path: 'res/img/plastic/',
	cards: [
		'bee',
		'bird',
		'building',
		'bus',
		'car',
		'cat',
		'crocodile',
		'crocodile2',
		'crown',
		'dog',
		'elephant',
		'elephant-xmas',
		'fish',
		'flower',
		'giraffe',
		'horse',
		'house',
		'lion',
		'polar-bear',
		'school',
		'ship',
		'solar-cells',
		'teddy',
		'tiger',
		'tree',
		'tree2',
		'turtle',
		'whale',
		'wind-turbine',
		'wolf'
	]
}

var POKEMON_PACK = {
	path: 'res/img/pokemon/',
	cards: [
		'abra',
		'bellsprout',
		'bulbasaur',
		'caterpie',
		'charmander',
		'charmander2',
		'dratini',
		'eevee',
		'jigglypuff',
		'mankey',
		'meowth',
		'mew',
		'pidgey',
		'pikachu',
		'pikachu2',
		'psyduck',
		'rattata',
		'rocket',
		'snorlax',
		'squirtle',
		'venonat',
		'weedle',
		'zubat'
	]
}

var SEASIDE_PACK = {
	path: 'res/img/seaside/',
	cards: [
		'beach-house',
		'boat',
		'bottle',
		'campfire',
		'cave1',
		'cave2',
		'coconut',
		'coral1',
		'coral2',
		'diving-helmet',
		'fish1',
		'fish2',
		'island',
		'knife',
		'lighter',
		'lighthouse',
		'livebuoy',
		'palm-tree',
		'pirate-flag',
		'red-crab',
		'shell',
		'shell2',
		'shell3',
		'shell-pearl',
		'ship',
		'starfish',
		'treasure-chest',
		'treasure-chest2',
		'treasure-map',
		'wave',
		'whale'
	]
}

var SPORT_PACK = {
	path: 'res/img/sport/',
	cards: [
		'archery',
		'badminton',
		'baseball',
		'basketball',
		'basketball2',
		'bowling',
		'box',
		'box2',
		'champion',
		'dumbbell',
		'football',
		'football2',
		'football3',
		'football4',
		'golf',
		'golf2',
		'gymnastics',
		'iceskate',
		'pool',
		'soccer',
		'soccer2',
		'soccer3',
		'sumo',
		'table-tennis',
		'table-tennis2',
		'tennis',
		'tennis2',
		'trophy',
		'voleyball'
	]
}

var STUDY_PACK = {
	path: 'res/img/study/',
	cards: [
		'abacus',
		'abacus2',
		'adn',
		'atom',
		'board',
		'books',
		'boy',
		'brain',
		'calculator',
		'certificate',
		'certificate2',
		'chemistry',
		'compass',
		'drawing',
		'girl',
		'globe',
		'globe2',
		'graduation',
		'graduation2',
		'handbook',
		'highlighter',
		'idea',
		'ideas',
		'lamp',
		'math',
		'microscope',
		'note',
		'note2',
		'paint',
		'stars',
		'todo',
		'tube',
		'tubes',
		'university',
		'writing'
	]
}

var SWEETANDFAT_PACK = {
	path: 'res/img/sweetandfat/',
	cards: [
		'beer',
		'cake',
		'cheeseburger',
		'chocolate',
		'chocolate-milkshake',
		'coffee',
		'coke',
		'donut',
		'fries',
		'hotdog',
		'icecream',
		'icecream-scoops',
		'iced-coffee',
		'jelly-gums',
		'meat',
		'mint-milkshake',
		'muffin',
		'pizza',
		'popcorn',
		'sausages',
		'skewer',
		'strawberry-milkshake',
		'vanilla-milkshake',
		'waffles'
	]
}

var XMAS_PACK = {
	path: 'res/img/xmas/',
	cards: [
		'baubles',
		'bell',
		'bells',
		'boy',
		'calendar',
		'candle',
		'candles',
		'candy',
		'champagne',
		'dessert',
		'elf',
		'gift',
		'gift2',
		'gingerbread',
		'gingerbread2',
		'girl',
		'gloves',
		'hat',
		'heart',
		'home',
		'letter',
		'omela',
		'ornament',
		'ornament2',
		'ornament3',
		'ornament4',
		'ornament5',
		'ornament6',
		'ornament7',
		'pie',
		'polar-bear',
		'reindeer',
		'reindeer2',
		'santa-smile',
		'santa-sunglasses',
		'sled',
		'snowglobe',
		'snowglobe2',
		'snowglobe3',
		'snowman',
		'snowman2',
		'snowman3',
		'sock',
		'star',
		'star2',
		'stocking',
		'tree',
		'wreath',
		'wreath2'
	]
}

var XMAS2_PACK = {
	path: 'res/img/xmas2/',
	cards: [
		'bag',
		'ball',
		'bear',
		'candle',
		'cookie',
		'cow',
		'crocodile',
		'dog',
		'elephant',
		'gift',
		'gift2',
		'gingerbread-man',
		'giraffe',
		'horse',
		'horse2',
		'house',
		'lion',
		'mistletoe',
		'monkey',
		'nutcracker',
		'panda',
		'penguin',
		'reindeer',
		'santa',
		'snowball',
		'snowman',
		'socks',
		'star',
		'tree',
		'wreath'
	]
}

var themes = ['Animales I', 'Animales II', 'Animales III', 'Campamento', 'Comida', 'Cool Animals I', 'Cool Animals II', 'Cuentos de Hadas', 'Deporte', 'Estudio', 'Frutas', 'Halloween', 'Huevos de Pascua', 'Jengibre', 'Mar', 'Navidad I', 'Navidad II', 'Perros', 'Plástico', 'Pokemon', 'Suculento'];
var levels = ['Fácil', 'Medio', 'Difícil', 'Insano'];
var highScores = readScores();

var game = null;
var level = -1;
var theme = '';
var currentRecords = [];
var currentType = null;
var currentIndex = -1;
var currentPlayer = '';

class AudioController {
    constructor() {
        // this.bgMusic = new Audio('res/audio/creepy.mp3');
        // this.flipSound = new Audio('https://github.com/pablogaravito/memory-cards/raw/master/res/audio/flip.wav');
        // this.matchSound = new Audio('https://github.com/pablogaravito/memory-cards/raw/master/res/audio/match.wav');
        // this.victorySound = new Audio('https://github.com/pablogaravito/memory-cards/raw/master/res/audio/victory.wav');
        // this.gameOverSound = new Audio('https://github.com/pablogaravito/memory-cards/raw/master/res/audio/gameOver.wav');
        this.flipSound = new Audio('./res/audio/flip.wav');
        this.matchSound = new Audio('./res/audio/match.wav');
        this.victorySound = new Audio('./res/audio/victory.wav');
        this.gameOverSound = new Audio('./res/audio/game-over.wav');
        // this.bgMusic.volume = 0.3;
        // this.bgMusic.loop = true;
    }
    // startMusic() {
    //     this.bgMusic.play();
    // }
    // stopMusic() {
    //     this.bgMusic.pause();
    //     this.bgMusic.currentTime = 0;
    // }
    flip() {
        this.flipSound.play();
    }
    match() {
        this.matchSound.play();
    }
    victory() {
        // this.stopMusic();
        this.victorySound.play();
    }
    gameOver() {
        // this.stopMusic();
        this.gameOverSound.play();
    }
}

class Game {
    constructor() {     
		// this.totalTime = 60;
		// this.timeRemaining = this.totalTime;
        this.timer = document.querySelector('#time-remaining');
        this.flips = document.querySelector('#flips');
        this.audioController = new AudioController();
    }
    startGame() {
        this.matches = 0;
        let cardNumber;
        switch(level) {
            case 0:
				this.totalTime = 80;
                cardNumber = 12;
                break;
            case 1:
				this.totalTime = 70;
                cardNumber = 18;
                break;
            case 2:
				this.totalTime = 60;
                cardNumber = 24;
                break;
            case 3:
				this.totalTime = 65;
                cardNumber = 32;
                break;
            default:
				this.totalTime = 60;
                cardNumber = 18;
                break;
        }

		this.timeRemaining = this.totalTime;
        let currentTheme;

        switch(theme.toLocaleLowerCase()) {
            case 'suculento':
                currentTheme = SWEETANDFAT_PACK;
                break;
            case 'animales i':
                currentTheme = ANIMALS_PACK;
                break;
            case 'animales ii':
                currentTheme = CUTEANIMALS_PACK;
                break;
            case 'animales iii':
                currentTheme = ANIMALS4CHILDREN_PACK;
                break;
            case 'campamento':
                currentTheme = CAMPING_PACK
                break;
            case 'comida':
                currentTheme = FOOD_PACK;
                break;
            case 'cool animals i':
                currentTheme = INCOGNITO1_PACK;
                break;
            case 'cool animals ii':
                currentTheme = INCOGNITO2_PACK;
                break;
            case 'cuentos de hadas':
                currentTheme = FAIRY_PACK;
                break;
            case 'deporte':
                currentTheme = SPORT_PACK;
                break;
            case 'estudio':
                currentTheme = STUDY_PACK;
                break;
            case 'frutas':
                currentTheme = FRUIT_PACK;
                break;
            case 'halloween':
                currentTheme = HALLOWEEN_PACK;
                break;
            case 'huevos de pascua':
                currentTheme = EASTER_PACK;
                break;
            case 'jengibre':
                currentTheme = GINGERBREAD_PACK;
                break;
            case 'mar':
                currentTheme = SEASIDE_PACK;
                break;
            case 'navidad i':
                currentTheme = XMAS_PACK;
                break; 
            case 'navidad ii':
                currentTheme = XMAS2_PACK;
                break; 
            case 'perros':
                currentTheme = DOGS_PACK;
                break; 
            case 'plástico':
                currentTheme = PLASTIC_PACK;
                break; 
            case 'pokemon':
                currentTheme = POKEMON_PACK;
                break;
            default:
                currentTheme = XMAS_PACK;
        }

        this.cardToCheck = null;
        this.cardsArray = this.selectCards(cardNumber, currentTheme.cards);
        document.body.classList.add('in-game');

        populateBoard(currentTheme, this.cardsArray);
        const cards = Array.from(document.getElementsByClassName('card'));
        cards.forEach(card => {
            card.addEventListener('click', () => {
                this.flipCard(card);
            });
        });
        this.hideCards();
        this.currentFlips = 0;
        this.flips.innerText = this.currentFlips;
        this.timeRemaining = this.totalTime;
        this.matchedCards = [];
        this.busy = true;
        setTimeout(() => {
            // this.audioController.startMusic();
            this.countDown = this.startCountDown();
            this.busy = false;
        }, 500);
    }
    selectCards(totalCards, cardSet) {   
        const cardsNeeded = totalCards/2;
        const shuffledCards = this.shuffleCards(cardSet);
        const cardList = shuffledCards.slice(shuffledCards.length - cardsNeeded);
        return this.shuffleCards(cardList.concat(cardList));
    }
    shuffleCards(cardsArray) {
        const newCardsArray = cardsArray.slice();

        //modern Fisher Yates algorithm
        let temp;
        for (let i = newCardsArray.length - 1; i > 0; i--) {
            let randIndex = Math.floor(Math.random() * (i+1));
            temp = newCardsArray[i];
            newCardsArray[i] = newCardsArray[randIndex];
            newCardsArray[randIndex] = temp;
        }
        return newCardsArray;
    }
    hideCards() {
        const cards = Array.from(document.getElementsByClassName('card'));      
        cards.forEach(card => {
            card.classList.remove('visible');
            card.classList.remove('matched');
        });
    };
    startCountDown() {
        return setInterval(() => {
            this.timeRemaining--;
            this.timer.innerText = this.timeRemaining;
            if (this.timeRemaining === 0)
                this.gameOver();
        }, 1000);
    }
    gameOver() {
        clearInterval(this.countDown);
        this.audioController.gameOver();
        document.querySelector('#result').innerText = 'Se acabó el tiempo!';
        document.querySelector('#details').innerText = `Lograste ${this.matches} de ${(this.cardsArray.length)/2} aciertos`;
        document.querySelector('#game-ended-text').classList.remove('hidden');
        this.hideCards();
    }
    victory() {
        clearInterval(this.countDown);
        this.audioController.victory();
        addScore(game.totalTime-game.timeRemaining, game.currentFlips, theme, level);
    }
    flipCard(card) {
        if(this.canFlipCard(card)) {
            this.audioController.flip();
            this.currentFlips++;
            this.flips.innerText = this.currentFlips;
            card.classList.add('visible');

            if (this.cardToCheck) 
                this.checkForCardMatch(card);
            else
                this.cardToCheck = card;
        }
    }
    getCardType(card) {
        return card.getElementsByClassName('card-value')[0].src;
    }
    checkForCardMatch(card) {
        if (this.getCardType(card) === this.getCardType(this.cardToCheck))
            this.cardMatch(card, this.cardToCheck);
        else
            this.cardMisMatch(card, this.cardToCheck);

        this.cardToCheck = null;
    }
    cardMatch(card1, card2) {
        this.matchedCards.push(card1);
        this.matchedCards.push(card2);
        card1.classList.add('matched');
        card2.classList.add('matched');
        this.audioController.match();
        if (this.matchedCards.length === this.cardsArray.length)
            this.victory();
        this.matches++;
    }
    cardMisMatch(card1, card2) {
        this.busy = true;
        setTimeout(() => {
            card1.classList.remove('visible');
            card2.classList.remove('visible');
            this.busy = false;
        }, 1000);      
    }
    canFlipCard(card) {
        return !this.busy && !this.matchedCards.includes(card) && card !== this.cardToCheck;
    }
}

function fillScores() {
    for(let i = 0; i < themes.length; i++) {
        if (!(highScores.some(e => e.theme === themes[i]))) {
            for(let j = 0; j < levels.length; j++) {
                let score = {
                    theme: themes[i],
                    level: j,
                    records: []
                }
                highScores.push(score);
            }
        } 
     }
     saveScores();
}

function populateBoard(pack, cardSet) {
    const board = document.querySelector('.card-container');
    const gameInfoContainer = document.querySelector('.game-info-container');
    const numCards = cardSet.length;
    switch(numCards) {
        case 12:
            board.classList.remove('mid', 'hard', 'insane');
            board.classList.add('easy');
            gameInfoContainer.classList.remove('mid', 'hard', 'insane');
            gameInfoContainer.classList.add('easy');
            break;
        case 18:
            board.classList.remove('easy', 'hard', 'insane');
            board.classList.add('mid');
            gameInfoContainer.classList.remove('easy', 'hard', 'insane');
            gameInfoContainer.classList.add('mid');
            break;
        case 24:
            board.classList.remove('easy', 'mid', 'insane');
            board.classList.add('hard');
            gameInfoContainer.classList.remove('easy', 'mid', 'insane');
            gameInfoContainer.classList.add('hard');
            break;
        case 32:
            board.classList.remove('easy', 'mid', 'hard');
            board.classList.add('insane');
            gameInfoContainer.classList.remove('easy', 'mid', 'hard');
            gameInfoContainer.classList.add('insane');
            break;
        default:
            board.classList.remove('easy', 'hard', 'insane');
            board.classList.add('mid');
            gameInfoContainer.classList.remove('easy', 'hard', 'insane');
            gameInfoContainer.classList.add('mid');
            break;
    }

    board.innerHTML = '';
    for (let i = 1; i <= numCards; i++) {
        
        const card = document.createElement('div');
        card.classList.add('card');
        const decorationFileName = '0_decoration';
        const cardBackFileName = '0_card-back';

        //corner decorations shared for both card Back and Front
        const decorationSrc = `${pack.path}${decorationFileName}.png`;
        const cardBackSrc = `${pack.path}${cardBackFileName}.png`;
        const topLeftImg = document.createElement('img');
        topLeftImg.classList.add('card-decoration');
        topLeftImg.classList.add('top-left');
        topLeftImg.src = decorationSrc;
        const bottomLeftImg = document.createElement('img');
        bottomLeftImg.classList.add('card-decoration');
        bottomLeftImg.classList.add('bottom-left');
        bottomLeftImg.src = decorationSrc;
        const topRightImg = document.createElement('img');
        topRightImg.classList.add('card-decoration');
        topRightImg.classList.add('top-right');
        topRightImg.src = decorationSrc;
        const bottomRightImg = document.createElement('img');
        bottomRightImg.classList.add('card-decoration');
        bottomRightImg.classList.add('bottom-right');
        bottomRightImg.src = decorationSrc;

        //cardBack
        const cardBack = document.createElement('div');
        cardBack.classList.add('card-back');
        cardBack.classList.add('card-face');      

        const imgBack = document.createElement('img');
        imgBack.classList.add('img-back');
        imgBack.src = cardBackSrc;
        cardBack.appendChild(topLeftImg);
        cardBack.appendChild(bottomLeftImg);
        cardBack.appendChild(topRightImg);
        cardBack.appendChild(bottomRightImg);
        cardBack.appendChild(imgBack);

        const topLeftImg2 = document.createElement('img');
        topLeftImg2.classList.add('card-decoration');
        topLeftImg2.classList.add('top-left');
        topLeftImg2.src = decorationSrc;
        const bottomLeftImg2 = document.createElement('img');
        bottomLeftImg2.classList.add('card-decoration');
        bottomLeftImg2.classList.add('bottom-left');
        bottomLeftImg2.src = decorationSrc;
        const topRightImg2 = document.createElement('img');
        topRightImg2.classList.add('card-decoration');
        topRightImg2.classList.add('top-right');
        topRightImg2.src = decorationSrc;
        const bottomRightImg2 = document.createElement('img');
        bottomRightImg2.classList.add('card-decoration');
        bottomRightImg2.classList.add('bottom-right');
        bottomRightImg2.src = decorationSrc;

        //cardFront
        const cardFront = document.createElement('div');
        cardFront.classList.add('card-front');
        cardFront.classList.add('card-face');       

        const imgFront = document.createElement('img');
        imgFront.classList.add('card-value');
        const imgSrc = `${pack.path}${cardSet[i-1]}.png`;
        imgFront.src = imgSrc;
        cardFront.appendChild(topLeftImg2);
        cardFront.appendChild(bottomLeftImg2);
        cardFront.appendChild(topRightImg2);
        cardFront.appendChild(bottomRightImg2);
        cardFront.appendChild(imgFront);
        card.appendChild(cardBack);
        card.appendChild(cardFront);
        board.appendChild(card);
    }
}

function fillLevelSelect() {
    const selectDifficulty = document.querySelector('#selectLevel');
    
    for (let index = 0; index < levels.length; index++) {
        selectDifficulty.options[selectDifficulty.options.length] = new Option(levels[index], index);       
    }
}
function fillThemesSelect() {
    const selectTheme = document.querySelector('#selectTheme');
    
    for (let index = 0; index < themes.length; index++) {
        selectTheme.options[selectTheme.options.length] = new Option(themes[index], index);       
    }
}

function readScores() {
    return JSON.parse(localStorage.getItem('highScores')) || [];
}

function saveScores() {
    localStorage.setItem('highScores', JSON.stringify(highScores));
}

function addScore(time, flips, theme, level) {
    currentType = highScores.find(score => {
        return score.theme === theme && score.level === level
    });
    const record = {
        time: time,
        flips: flips,
        name: ''
    }
    if (currentType) {
        compareScores(currentType.records, record);
    }
}

function compareScores(records, currScore) {
    let newArray = records.slice();
    newArray.push(currScore);
    newArray.sort(
        function(a, b) {          
           if (parseInt(a.time) === parseInt(b.time)) {
              return parseInt(a.flips) - parseInt(b.flips);
           }
           return parseInt(a.time) > parseInt(b.time) ? 1 : -1;
        });
    newArray = newArray.slice(0, 5);
    const i = newArray.indexOf(currScore);
    if (i !== -1) {
        currentRecords = newArray;
		currentType.records = currentRecords;
        currentIndex = i;
		const recordsContainer = document.querySelector('.dividendo');
		recordsContainer.classList.remove('hidden');
		saveScores();
		console.log(theme);
		console.log(level);
		readRecords(theme, level);
		const cell = document.querySelector(`.pos${i+1}`);
        const input = cell.querySelector('.name > input[type=text]');
        input.placeholder = 'Tu nombre...';
        input.classList.remove('noselect');
        input.removeAttribute('readonly');
        input.focus();

		input.addEventListener('blur', () => {
            input.classList.add('noselect');
            input.setAttribute('readonly', true);
            const newName = input.value;
            const arrowBtn = document.querySelector('#arrow-img');
            arrowBtn.classList.add('enabled');
            currentPlayer = newName;
            currentType.records[i].name = currentPlayer;
            saveScores();
            readRecords(theme, level);
			// restoreDefaults();
        });    
        
        input.addEventListener('keyup', e => {
            if (e.key === "Enter") {
                input.classList.add('noselect');
                input.setAttribute('readonly', true);
                const newName = input.value;
                const arrowBtn = document.querySelector('#arrow-img');
                arrowBtn.classList.add('enabled');
				currentPlayer = newName;
                currentType.records[i].name = currentPlayer;
                saveScores();
                readRecords(theme, level);
				// restoreDefaults();
            }
        });
    } else {
        document.querySelector('#result').innerText = 'VICTORIA!';
        document.querySelector('#details').innerText = `Lo lograste en ${game.totalTime - game.timeRemaining} segundos y ${game.currentFlips} jugadas!`;
        document.querySelector('#game-ended-text').classList.remove('hidden');
    }
}

function defineGame() {
    const selectLevel = document.querySelector('#selectLevel');
    const selectTheme = document.querySelector('#selectTheme');
    level = parseInt(selectLevel.value);
    theme = selectTheme.selectedOptions[0].text;
}

function restoreDefaults() {
    currentRecords = [];
    currentType = null;
    currentIndex = -1;
    currentPlayer = '';
}

function readRecords(theme, level) {
    highScores = readScores();
    currentType = highScores.find(score => {
        return score.theme === theme && score.level === level
    });
    let currRecords;
    if (currentType) {
        currRecords = currentType.records;
    } else {
        currRecords = [];
    }

	console.log(currentType);
	console.log(currRecords);
    
    for (let index = 0; index < 5; index++) {
        let cell = document.querySelector(`.pos${index+1}`);
        if (currRecords[index]) {
            const nameDiv = cell.querySelector('.name');
            nameDiv.innerHTML = '';
            const nameInput = document.createElement('input');
            nameInput.setAttribute('type', 'text');
            nameInput.setAttribute('value', currRecords[index].name);
            nameInput.classList.add('noselect');
            nameInput.setAttribute('readonly', true);
            nameInput.setAttribute('maxlength', 12);
            nameDiv.appendChild(nameInput);

            cell.querySelector('.time').innerText = currRecords[index].time;
            cell.querySelector('.flips').innerText = currRecords[index].flips;
        } else {
            cell.querySelector('.name > input[type=text]').value = '-';
            cell.querySelector('.time').innerText = '-';
            cell.querySelector('.flips').innerText = '-';
        }
    }
}

function ready() {   
    fillScores();
    fillLevelSelect();
    fillThemesSelect();
    const startGameBtn = document.querySelector('#startGame');
    startGameBtn.addEventListener('click', () => {
        defineGame();
        const settingsDiv = document.querySelector('.settings');
        settingsDiv.classList.add('hidden');
        const startOverlay = document.querySelector('#start-game-text');
        startOverlay.classList.remove('hidden');
    });
	const arrowBtn = document.querySelector('#arrow-img');
    arrowBtn.addEventListener('click', () => {
        if (!(arrowBtn.classList.contains('enabled'))) {
            return;
        } else {
            arrowBtn.classList.remove('enabled');
			document.querySelector('.dividendo').classList.add('hidden'); 
			document.querySelector('#result').innerText = 'FELICIDADES! NUEVO RECORD!';
			document.querySelector('#details').innerText = `${currentPlayer}, lo lograste en ${game.totalTime - game.timeRemaining} segundos y ${game.currentFlips} jugadas!`;
			document.querySelector('#game-ended-text').classList.remove('hidden');
			restoreDefaults();
        }
    });
    game = new Game();   
    const gameContainer = document.querySelector('.game-container');

    const startGameOverLay = document.querySelector('#start-game-text');
    const restartOverlay = document.querySelector('#restart-overlay');
    const settingsOverlay = document.querySelector('#settings-overlay');
    startGameOverLay.addEventListener('click', () => {
        startGameOverLay.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        game.startGame();
    });
    restartOverlay.addEventListener('click', () => {
        document.querySelector('#game-ended-text').classList.add('hidden');
        game.startGame();
    });
    settingsOverlay.addEventListener('click', () => {
        document.querySelector('#game-ended-text').classList.add('hidden');
        document.body.classList.remove('in-game');
        gameContainer.classList.add('hidden');
        document.querySelector('.settings').classList.remove('hidden');
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ready);
} else {
    ready();
}

